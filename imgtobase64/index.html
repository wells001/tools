<html>  
<meta http-equiv="X-UA-Compatible" content="chrome=1">  
<head>  
	<script type="text/javascript" src="jquery/jquery.js"></script>
	<script>  
		function toSmall (input,callback){
			function uploadBtnClick(){
				if(window.File && window.FileReader && window.FileList && window.Blob){ 
					file = input.files[0];

					processfile(file);
				}else{
					alert("Upload picture is not fully supported in this browser");
				}

			}


			function processfile(file) {
				var reader = new FileReader();
				if (!file) {
					return;
				}
				reader.onload = function (event) {
					var blob = new Blob([event.target.result]); 

					window.URL = window.URL || window.webkitURL;
					var blobURL = window.URL.createObjectURL(blob); 

					var image = new Image();
					console.log(blobURL);
					image.src = blobURL;
					image.onload = function() {
						console.log(image);
						var resized = resizeMe(image); 
						
						var img = document.createElement('img');
						img.src = resized;
						input.parentNode.appendChild(img);
						console.log(resized);
						// console.log(dataURItoBlob(resized));
						var blob = dataURItoBlob(resized); // 上一步中的函数
						// var canvas = document.createElement('canvas');
						// var dataURL = canvas.toDataURL('image/jpeg', 0.5);
						f = new File( [blob], "file.png",{type : "image/png"} );
						var fd = new FormData();
						fd.append('file', f);
						console.log(f);
						var str = 'sdfasdfadfasdfa';
						var xhr = new XMLHttpRequest();
						// xhr.open("post","http://jgntech.ngrok.xiaomiqiu.cn/carcustom/upload");
						xhr.open("post","http://47.92.126.248:8080/carcustom/upload");
						// xhr.setRequestHeader("Content-Type","multipart/form-data");
						xhr.setRequestHeader("Authorization",str);
						xhr.send(fd);
						xhr.onreadystatechange =  function (){

							if(xhr.readyState == 4&&xhr.status == 200){

								var res = xhr.responseText;


								// res=eval('('+res+')');
								if (callback) {
									callback(res);
									return;
								}
								console.log(res)

							}

						};
					};
				};
				reader.readAsArrayBuffer(file);
			}

			function resizeMe(img) {
				var max_width = 2300; 
				var max_height = 2300; 

				var canvas = document.createElement('canvas');
				var width = img.width;
				var height = img.height;

				if(width > height) {
					if(width > max_width) {
						height = Math.round(height *= max_width / width);
						width = max_width;
					}
				} 
				else{
					if(height > max_height) {
						width = Math.round(width *= max_height / height);
						height = max_height;
					}
				}

				canvas.width = width;
				canvas.height = height;

				var ctx = canvas.getContext("2d");
				ctx.drawImage(img, 0, 0, width, height);
				return canvas.toDataURL("image/jpeg",0.7); 
			}

			uploadBtnClick();
		}
		function dataURItoBlob(base64Data) {
			var byteString;
			if (base64Data.split(',')[0].indexOf('base64') >= 0)
				byteString = atob(base64Data.split(',')[1]);
			else
				byteString = unescape(base64Data.split(',')[1]);
			var mimeString = base64Data.split(',')[0].split(':')[1].split(';')[0];
			var ia = new Uint8Array(byteString.length);
			for (var i = 0; i < byteString.length; i++) {
				ia[i] = byteString.charCodeAt(i);
			}
			return new Blob([ia], {type:mimeString});
		}



	</script>  
</head>  
<body bgcolor="#E6E6FA">  
	<div>  
		<input type="file" id="files">
	</div>  
	<script type="text/javascript">
		document.querySelector('#files').onchange = function() {
			console.log(this.files[0]);
			toSmall(this,function(data){
				console.log(data);
			});
		};
	</script>
</body>  
</html>  
